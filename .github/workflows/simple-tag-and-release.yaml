name: Release (reusable)

on:
  workflow_call:
    inputs:
      semver:
        description: "Release Semantic Version (e.g. 1.15.2 or v1.15.2)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out full history
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Normalize version (ensure leading v)
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          RAW="${{ inputs.semver }}"
          if [[ "$RAW" =~ ^v ]]; then
            VER="$RAW"
          else
            VER="v${RAW}"
          fi
          MAJOR="${VER#v}"
          MAJOR="${MAJOR%%.*}"
          {
            echo "version=$VER"
            echo "major=$MAJOR"
          } >> "$GITHUB_OUTPUT"

      - name: Create release tag
        id: create_tag
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.ver.outputs.version }}';
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              ref:   `refs/tags/${version}`,
              sha:   context.sha
            });
            core.info(`Created tag '${version}' at commit ${context.sha}`);

      - name: Create GitHub release
        uses: softprops/action-gh-release@72f2c25fcb47643c292f7107632f7a47c1df5cd8
        with:
          tag_name: ${{ steps.ver.outputs.version }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete release tag if workflow fails or is cancelled
        if: ${{ (failure() || cancelled()) && steps.create_tag.outcome == 'success' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.ver.outputs.version }}';
            const ref = `tags/${version}`;
            core.info(`Deleting tag ref '${ref}' due to failure or cancellation.`);
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo:  context.repo.repo,
                ref
              });
            } catch (e) {
              core.warning(`Failed to delete tag ${ref}: ${e.message}`);
            }

      - name: Move/create major and latest tags
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.ver.outputs.version }}';
            const major   = '${{ steps.ver.outputs.major }}';

            const versionRef        = `tags/${version}`;
            const majorRefNoPrefix  = `tags/v${major}`;
            const majorRefFull      = `refs/${majorRefNoPrefix}`;
            const latestRefNoPrefix = `tags/latest`;
            const latestRefFull     = `refs/${latestRefNoPrefix}`;

            // Resolve the commit SHA of the version tag
            const newTag = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              ref:   versionRef
            });
            const commitSha = newTag.data.object.sha;
            core.info(`'${version}' points to ${commitSha}`);

            // Delete existing major tag if present
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo:  context.repo.repo,
                ref:   majorRefNoPrefix
              });
              core.info(`Deleted existing major tag 'v${major}'.`);
            } catch (e) {
              core.warning(`No existing 'v${major}' tag to delete (or delete failed): ${e.message}`);
            }

            // Create/update major tag
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              ref:   majorRefFull,
              sha:   commitSha
            });
            core.info(`Created/updated major tag 'v${major}' -> ${commitSha}.`);

            // Delete existing 'latest' tag if present
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo:  context.repo.repo,
                ref:   latestRefNoPrefix
              });
              core.info(`Deleted existing 'latest' tag.`);
            } catch (e) {
              core.warning(`No existing 'latest' tag to delete (or delete failed): ${e.message}`);
            }

            // Create/update 'latest' tag
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              ref:   latestRefFull,
              sha:   commitSha
            });
            core.info(`Created/updated 'latest' -> ${commitSha}.`);
